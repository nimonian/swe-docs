<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Javascript Web Tokens | SWE 2.0</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@6.6.96/css/materialdesignicons.min.css">
    <meta name="description" content="Documentation for SWE 2.0">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.7b02d6e4.css" as="style"><link rel="preload" href="/assets/js/app.fdcd5113.js" as="script"><link rel="preload" href="/assets/js/2.da368b61.js" as="script"><link rel="preload" href="/assets/js/20.15cbc73c.js" as="script"><link rel="prefetch" href="/assets/js/10.aef4f5db.js"><link rel="prefetch" href="/assets/js/11.131cdaf7.js"><link rel="prefetch" href="/assets/js/12.41e8b4af.js"><link rel="prefetch" href="/assets/js/13.4c361092.js"><link rel="prefetch" href="/assets/js/14.3cb010b7.js"><link rel="prefetch" href="/assets/js/15.84cb7d41.js"><link rel="prefetch" href="/assets/js/16.73a58dec.js"><link rel="prefetch" href="/assets/js/17.1e2a3b6f.js"><link rel="prefetch" href="/assets/js/18.ecc9bd54.js"><link rel="prefetch" href="/assets/js/19.bea94ec4.js"><link rel="prefetch" href="/assets/js/21.72adbcf8.js"><link rel="prefetch" href="/assets/js/3.efd1d24e.js"><link rel="prefetch" href="/assets/js/4.66006680.js"><link rel="prefetch" href="/assets/js/5.68481791.js"><link rel="prefetch" href="/assets/js/6.7f86ac42.js"><link rel="prefetch" href="/assets/js/7.7208f546.js"><link rel="prefetch" href="/assets/js/8.ae1faefc.js"><link rel="prefetch" href="/assets/js/9.93901f70.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7b02d6e4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">SWE 2.0</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/config/" class="nav-link">
  Config
</a></div><div class="nav-item"><a href="https://v1.vuepress.vuejs.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  VuePress
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/config/" class="nav-link">
  Config
</a></div><div class="nav-item"><a href="https://v1.vuepress.vuejs.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  VuePress
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/notes/bootcamp/" class="sidebar-heading clickable"><span>Bootcamp</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/bootcamp/objects.html" class="sidebar-link">Objects</a></li><li><a href="/notes/bootcamp/classes.html" class="sidebar-link">Classes</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/notes/module-2/" class="sidebar-heading clickable router-link-active open"><span>Module 2</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/module-2/rest.html" class="sidebar-link">REST APIs</a></li><li><a href="/notes/module-2/basic-auth.html" class="sidebar-link">Securing APIs with Basic Auth</a></li><li><a href="/notes/module-2/jwt.html" aria-current="page" class="active sidebar-link">Javascript Web Tokens</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/module-2/jwt.html#what-are-jwts" class="sidebar-link">What are JWTs?</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/module-2/jwt.html#making-id-tokens" class="sidebar-link">Making id tokens</a></li><li class="sidebar-sub-header"><a href="/notes/module-2/jwt.html#signing-tokens" class="sidebar-link">Signing tokens</a></li><li class="sidebar-sub-header"><a href="/notes/module-2/jwt.html#so-what-are-jwts" class="sidebar-link">So what are JWTs?</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/module-2/jwt.html#working-with-jwts" class="sidebar-link">Working with JWTs</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/module-2/jwt.html#generating-jwts" class="sidebar-link">Generating JWTs</a></li><li class="sidebar-sub-header"><a href="/notes/module-2/jwt.html#the-jwt-flow" class="sidebar-link">The JWT flow</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/module-2/jwt.html#refresh-tokens" class="sidebar-link">Refresh tokens</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/module-2/jwt.html#expiring-tokens" class="sidebar-link">Expiring tokens</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/module-2/jwt.html#assignment-cloudbox-sign-in" class="sidebar-link">📦 Assignment: Cloudbox sign in</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="javascript-web-tokens"><a href="#javascript-web-tokens" class="header-anchor">#</a> Javascript Web Tokens</h1> <h2 id="what-are-jwts"><a href="#what-are-jwts" class="header-anchor">#</a> What are JWTs?</h2> <p>Instead of username and password, we give each user a special token to prove their identity. These look like</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1lIjoibW9ycGhldXMiLCJpYXQiOjE2NTMxMDI3MzR9.zNYcb1c9v8EO-oszD8cs4LDEzuS-epfQINWHfwQ48SI'</span>
</code></pre></div><p>A user tells us their username and password once, and in return they get a token like this. Then, whenever they want to access a protected resource, they show us this token.</p> <p>If we split this at the full stops <code>.</code> we get three parts:</p> <ul><li><p><strong>Header:</strong> The first part <code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9</code> is called the header, and is a Base 64 encoding of some metadata about the token.</p></li> <li><p><strong>Payload:</strong> The middle part <code>eyJuYW1lIjoibW9ycGhldXMiLCJpYXQiOjE2NTMxMDI3MzR9</code> is the payload. It is a Base 64 encoding of an object of data about the user, such as their name, along with the time at which the token was made.</p></li> <li><p><strong>Signature:</strong> The last part <code>zNYcb1c9v8EO-oszD8cs4LDEzuS-epfQINWHfwQ48SI</code> is called the signature. We'll talk about that shortly!</p></li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Use the <code>atob()</code> function in the browser, or <code>Buffer.from()</code> in node, to decode the payload from Base64 into a readable string.</p></div> <h3 id="making-id-tokens"><a href="#making-id-tokens" class="header-anchor">#</a> Making id tokens</h3> <p>Let's say one of our users is called Morpheus and we want to use his name <code>morpheus</code> as a token. Well, this is dumb. Anbody could send us the word <code>morpheus</code> and get access to Morpheus' secrets.</p> <p>Maybe we could hash the word <code>morpheus</code> on the server and add that to the token? We'll use an algorithm I just invented called <code>stupidHash()</code>:</p> <ol><li>Map each letter to its position in the alphabet (e.g m =&gt; 13)</li> <li>Multiply the numbers together</li></ol> <p>We get the hash <code>896313600</code>. Now, when Morpheus gives us his password, we send a token <code>morpheus.896313600</code> to our user on the frontend. A few minutes later, a user sends it back to us, and says &quot;Hey, I got this special token you made for me! Can I have Morpheus' secret document from the database?&quot;</p> <p>This is better, but if an attacker knew our algorithm, they could take the username <code>morpheus</code> and work out the hash <code>896313600</code> and now they have the exact same token. Damn.</p> <h3 id="signing-tokens"><a href="#signing-tokens" class="header-anchor">#</a> Signing tokens</h3> <p>Well, what if we chose a <code>SECRET_PHRASE</code> and kept that on the server? If we appended this to the username before hashing it, the result is called a <em>signature</em>. When we maintain a secret and mix it in with some data before hashing it, this is called <em>signing</em> the data.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// server.js</span>
<span class="token keyword">const</span> <span class="token constant">SECRET_PHRASE</span> <span class="token operator">=</span> <span class="token string">'thereisnospoon'</span>
<span class="token keyword">const</span> signature <span class="token operator">=</span> <span class="token function">stupidHash</span><span class="token punctuation">(</span><span class="token string">'morpheus'</span> <span class="token operator">+</span> <span class="token constant">SECRET_PHRASE</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token string">'morpheus'</span> <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> signature
<span class="token comment">// morpheus.281661577413970231296000</span>
</code></pre></div><p>Now, even if a hacker knew the username <code>morpheus</code> and the <code>stupidHash()</code> algorithm, they wouldn't be able to replicate Morpheus' token, because they don't know the secret phrase! So, if someone gives the token
<code>morpheus.281661577413970231296000</code> back to the server, we know it must be Morpheus. (This assumes the token hasn't been stolen from Morpheus, which is a different matter.)</p> <p>This is the right idea, but it is also a terrible algorithm - it could easily be hacked by brute force.</p> <h3 id="so-what-are-jwts"><a href="#so-what-are-jwts" class="header-anchor">#</a> So what are JWTs?</h3> <p>A JWT is formed by taking a javascript object such as</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'morpheus'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">iat</span><span class="token operator">:</span> <span class="token string">'1653102734'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>and signing it with a large, random <code>SECRET</code> string. The hashing algorithm is much better than stupidHash. The <code>iat</code> property stands for <em>issued at</em> and is the time at which the token was generated (in <a href="https://www.codingem.com/epoch-time/" target="_blank" rel="noopener noreferrer">epoch seconds<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>).</p> <h2 id="working-with-jwts"><a href="#working-with-jwts" class="header-anchor">#</a> Working with JWTs</h2> <h3 id="generating-jwts"><a href="#generating-jwts" class="header-anchor">#</a> Generating JWTs</h3> <p>The npm library <a href="https://www.npmjs.com/package/jsonwebtoken" target="_blank" rel="noopener noreferrer">jsonwebtoken<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> can sign JWTs with a secret for us. It will also add an <code>iat</code> value for us so we don't need to calculate that. We should <code>npm i jsonwebtoken</code> and then</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonwebtoken'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> token <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'morpheus'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'thereisnospoon'</span><span class="token punctuation">)</span>
<span class="token comment">// eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1lIjoibW9ycGhldXMiLCJpYXQiOjE2NTMxMjE0MjZ9.d-U-OdG1eTVhfBeX9yJK8rbSeGyDg00wx4M1it3qDbc</span>
</code></pre></div><p>Of course, <code>'thereisnospoon'</code> is a poor secret - we should generate a random string.</p> <ol><li><p><code>npm install --D crypto dotenv</code></p></li> <li><p>Open a terminal, type <code>node</code> and hit enter to start an interactive node session.</p></li> <li><p>Type <code>require('crypto').randomBytes(64).toString('base64')</code> and copy the result (e.g. <code>b9bkPdGzuzNTruBor9Az89zZ31cqTLB6bj6zUdM6PI3UYrE1kcFVhMIZsOiLLEP4BVr027FPsyJ+/4nHFoNQUw==</code>). Hit ctrl+c twice to end the interactive session.</p></li> <li><p>Make a file in the root of your server directory called <code>.env</code> and save <code>TOKEN_SECRET=b9bkPdGzuzNTruBor9Az89zZ31cqTLB6bj6zUdM6PI3UYrE1kcFVhMIZsOiLLEP4BVr027FPsyJ+/4nHFoNQUw==</code> in the file.</p></li> <li><p>In any .js file where you want to use the secret, you can access it like this</p></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TOKEN_SECRET</span><span class="token punctuation">)</span>
</code></pre></div><p>So</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> token <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'morpheus'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TOKEN_SECRET</span><span class="token punctuation">)</span>
</code></pre></div><p>will create a legitimate jwt.</p> <h3 id="the-jwt-flow"><a href="#the-jwt-flow" class="header-anchor">#</a> The JWT flow</h3> <p>The whole flow looks like this:</p> <ol><li><p>A user sends their username and password to a server endpoint such as <code>/api/v1/login</code></p></li> <li><p>The server checks the username and password against the hash in our database with <code>bcypt.compare()</code></p></li> <li><p>If successful, the server signs an object containing some identifying information for the user, thus creating a JWT. The object in the payload should <strong>not</strong> contain the password or the hashed password for the user.</p></li> <li><p>The server sends this JWT to the user and the frontend stores it in <code>localStorage</code>.</p></li> <li><p>If the user needs to access a protected resource, they send the JWT. The server uses <code>jwt.verify()</code> to check that the token was signed with our secret and that the payload hasn't been changed.</p></li> <li><p>If the token is authentic, we grant access to the protected resource.</p></li></ol> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>The process of checking the token with <code>jwt.verify()</code> should be written in a middleware called <code>authorize</code> so it can be dropped in to any protected resource.</p></div> <h2 id="refresh-tokens"><a href="#refresh-tokens" class="header-anchor">#</a> Refresh tokens</h2> <h3 id="expiring-tokens"><a href="#expiring-tokens" class="header-anchor">#</a> Expiring tokens</h3> <p>The JWT we made above and sent to the user is called an <strong>access token</strong>. The problem with our method so far is that, if our access token got stolen, it gives the thief unlimited access to secrets on the server. For this reason, when we create a token, we should make it expire. In practice, tokens usually expire after about <code>1h</code> (depending on security needs), but we will make ours expire after <code>30s</code> to make testing easier:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> access_token <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'morpheus'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TOKEN_SECRET</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">expiresIn</span><span class="token operator">:</span> <span class="token string">'30s'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Now, if we try to use this token after 31 seconds, it will not work and <code>jwt.verify()</code> will fail. This is great - if the token gets stolen, the damage the thief can do it mitigated.</p> <p>So does the user have to send us their password every time the token expires? No - this is where <strong>refresh tokens</strong> come in.</p> <ol><li><p>When the user first sends their password to authenticate with the server, we create two tokens: one which expires called the <code>access_token</code>, and another which does not expire called the <code>refresh_token</code>.</p></li> <li><p>We save the refresh token in a list of <code>validRefreshTokens</code> on the server (ideally in a database) but an array will do for now.</p></li> <li><p>We send them both back to the user, and the user uses the access token to get secrets from the server until it expires.</p></li> <li><p>Now, if the user needs a new <code>access_token</code>, they can send their refresh token to an api endpoint such as <code>/api/v1/refresh</code> - if the token is verified as authentic, and if it is in the list of valid tokens, then we grant a new <code>access_token</code>.</p></li></ol> <p>When the user wants to sign out, we remove their refresh token from the list of valid refresh tokens.</p> <h2 id="assignment-cloudbox-sign-in"><a href="#assignment-cloudbox-sign-in" class="header-anchor">#</a> 📦 Assignment: Cloudbox sign in</h2> <p>We're finally at a point of being able to allow users to sign in to Cloudbox.</p> <ul><li>Add an endpoint for <code>/auth/signin</code> which accepts a username and password and responds with an access token if the credentials are valid.</li> <li>Modify your <code>authorize</code> middleware so that, instead of checking if the username and password is correct, it checks whether the token is valid.</li> <li>If you have the time, implement refresh tokens. You will need to add endpoints for <code>/auth/refresh</code> and <code>/auth/signout</code>.</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/notes/module-2/basic-auth.html" class="prev">
        Securing APIs with Basic Auth
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.fdcd5113.js" defer></script><script src="/assets/js/2.da368b61.js" defer></script><script src="/assets/js/20.15cbc73c.js" defer></script>
  </body>
</html>
